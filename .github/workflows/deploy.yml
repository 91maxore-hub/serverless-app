name: Deploy Serverless App

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Klona repo
      - name: Checkout repo
        uses: actions/checkout@v3

      # 2. Konfigurera AWS
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-1

      # 3. Synca webbfiler till S3 (exkluderar Lambda)
      - name: Deploy web files to S3
        run: |
          aws s3 sync ./ s3://serverless-bucket-2025/ --exclude "contactFormHandler.js" --delete
          echo "Web files deployed to S3"

      # 4. Zip Lambda-filen (fr√•n root)
      - name: Zip Lambda file
        run: |
          zip lambda.zip contactFormHandler.js
          echo "Lambda zip ready"

      # 5. Deploy Lambda
      - name: Deploy Lambda
        run: |
          aws lambda update-function-code \
            --function-name contactFormHandler \
            --zip-file fileb://lambda.zip
          echo "Lambda updated successfully"

      # 6. Rensa zip
      - name: Cleanup
        run: rm lambda.zip